using Client.Data;
using Client.DTOs;
using Client.DTOs.Flavor;
using Client.DTOs.Product;
using Client.Models;
using Client.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;

namespace Client.Controllers
{
    [Route("products")]
    [ApiController]
    public class ProductsController : ControllerBase
    {
        private readonly AppDbContext _appDbContext;

        public ProductsController(AppDbContext appDbContext, IAuthenticationService authenticationService)
        {
            _appDbContext = appDbContext;

        }
        [HttpPost]
        [Authorize]
        public async Task<IActionResult> Create([FromBody] ProductDto product)
        {
            var userId = User.FindFirst("userId")?.Value;

            if (!Guid.TryParse(userId, out var parsedUserId))
            {
                return Unauthorized(new { error = "Unauthorized" });
            }
            var enterpriseId = await _appDbContext.Enterprises.Where(e => e.ClientUserId.Equals(parsedUserId))
                .Select(e => e.Id)
                .FirstOrDefaultAsync();

            if (enterpriseId == Guid.Empty)
            {
                return BadRequest("Enterprise not found for the user.");
            }


            var newProduct = new Models.Product
            {
                Name = product.Name,
                Category = product.Category,
                Price = product.Price,
                Available = product.Available,
                EnterpriseId = enterpriseId
            };
            _appDbContext.Products.Add(newProduct);
            await _appDbContext.SaveChangesAsync();

            return NoContent();
        }

        [HttpGet]
        [Authorize]
        public async Task<IActionResult> Get()
        {
            var userId = User.FindFirst("userId")?.Value;

            if (!Guid.TryParse(userId, out var parsedUserId))
            {
                return Unauthorized(new { error = "Unauthorized" });
            }

            var products = await _appDbContext.Products
                .Where(p => p.Enterprise.ClientUserId.Equals(parsedUserId)).OrderBy(p => p.Category).Select(e => new ResponseProductDto(e.Id, e.Name, e.Category, e.Price, e.Available))
                .ToListAsync();
            return Ok(products);
        }
        [HttpGet("flavors")]
        [Authorize]
        public async Task<IActionResult> GetWithFlavours()
        {
            var userId = User.FindFirst("userId")?.Value;

            if (!Guid.TryParse(userId, out var parsedUserId))
            {
                return Unauthorized(new { error = "Unauthorized" });
            }

            var products = await _appDbContext.Products
                .Where(p => p.Enterprise.ClientUserId.Equals(parsedUserId))
                .OrderBy(p => p.Category)
                .Select(p => new ProductWithFlavorsDto(p.Id, p.Name, p.Category, p.Price, p.Available, p.Flavors.Select(f => new ResponseFlavorDto(f.ProductId, f.Id, f.Name, f.Price, f.IsAvailable)).ToList()))
                .ToListAsync();
            return Ok(products);
        }
        [HttpPatch("{productId}")]
        [Authorize]
        public async Task<IActionResult> Update(Guid productId,[FromBody] UpdateProductDto updateProductDto)
        {
            var userId = User.FindFirst("userId")?.Value;
            if (!Guid.TryParse(userId, out var parsedUserId))
            {
                return Unauthorized(new { error = "Unauthorized" });
            }
            var product = await _appDbContext.Products.Where(p => p.Id.Equals(productId) && p.Enterprise.ClientUserId.Equals(parsedUserId))
                .ExecuteUpdateAsync(product =>
                {
                    if (updateProductDto.Name != null)
                        product.SetProperty(p => p.Name, updateProductDto.Name);

                    if (updateProductDto.Price.HasValue)
                        product.SetProperty(p => p.Price, updateProductDto.Price.Value);

                    if (updateProductDto.Available.HasValue)
                        product.SetProperty(p => p.Available, updateProductDto.Available.Value);

                });
            if (product == 0)
            {
                return NotFound("Product not found");
            }


            return NoContent();
        }
    }
}
