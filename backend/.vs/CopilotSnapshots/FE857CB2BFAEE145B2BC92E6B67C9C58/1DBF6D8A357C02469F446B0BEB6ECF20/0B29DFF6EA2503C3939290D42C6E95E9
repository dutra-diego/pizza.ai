using Client.Data;
using Client.DTOs.Enterprise;
using Client.Models;
using Microsoft.EntityFrameworkCore;

namespace Client.Services
{
    public class EnterpriseService : IEnterpriseService
    {
        private readonly AppDbContext _appDbContext;

        public EnterpriseService(AppDbContext appDbContext)
        {
            _appDbContext = appDbContext;
        }

        public async Task CreateAsync(Guid userId, EnterpriseDTO enterpriseDto)
        {
            if (enterpriseDto == null)
                throw new ArgumentNullException(nameof(enterpriseDto), "Enterprise data is required");

            var isUserEnterpriseExists = await _appDbContext.Enterprises
                .FirstOrDefaultAsync(e => e.ClientUserId == userId);

            if (isUserEnterpriseExists != null)
                throw new InvalidOperationException("User already has an enterprise");

            var newEnterprise = new Enterprise
            {
                Name = enterpriseDto.Name,
                Address = enterpriseDto.Address,
                ClientUserId = userId
            };

            _appDbContext.Enterprises.Add(newEnterprise);
            await _appDbContext.SaveChangesAsync();
        }

        public async Task<EnterpriseResponseDto> GetByUserIdAsync(Guid userId)
        {
            var now = DateTime.UtcNow;
            var last7Days = now.AddDays(-7);
            var last14Days = now.AddDays(-14);
            var last30Days = now.AddDays(-30);

            var enterprise = await _appDbContext.Enterprises
                .Where(e => e.ClientUserId == userId)
                .Select(e => new EnterpriseResponseDto(
                    e.Name,
                    e.Address,
                    e.Orders.Count(o => o.CreatedAt >= last7Days),
                    e.Orders.Count(o => o.CreatedAt >= last14Days),
                    e.Orders.Count(o => o.CreatedAt >= last30Days),
                    e.Orders
                        .Where(o => o.CreatedAt >= last30Days)
                        .SelectMany(o => o.OrderProducts)
                        .Sum(op => op.TotalPrice)
                ))
                .FirstOrDefaultAsync();

            if (enterprise == null)
                throw new KeyNotFoundException("Enterprise not found");

            return enterprise;
        }
    }
}
